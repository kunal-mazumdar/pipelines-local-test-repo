resources:
  - name: git_repo
    type: GitRepo
    configuration:
      gitProvider: kunal_gh
      path: kunal-mazumdar/pipelines-local-test-repo
      branches:
        include: '{{ gitBranch }}'
  - name: buildInfo
    type: BuildInfo
    configuration:
      buildName: local_docker_build
      buildNumber: 1
      sourceArtifactory: int_default_artifactory
pipelines:
  - name: signed_pipelines_docker_manual
    configuration:
      jfrogCliVersion: 2
    steps:
      - name: build_push
        type: Bash
        configuration:
          inputResources:
            - name: git_repo
          integrations:
            - name: int_default_artifactory
          outputResources:
            - name: buildInfo
        execution:
          onExecute:
            - echo $res_git_repo_resourcePath
            - export IN_resourceName=git_repo
            - export IN_dockerImage=localhost:8082/docker-local/jfrog/pipelines-msg:latest
            - export IN_dockerFileName=Dockerfile
            - export IN_autoPublishBuildInfo=true
            - export IN_xrayScan=false
            - export IN_failOnScan=true
            - export IN_outputBuildInfoResourceName=buildInfo
            - cd $res_git_repo_resourcePath
            - echo $JFROG_CLI_BUILD_NAME
            - echo $JFROG_CLI_BUILD_NUMBER
            - export JFROG_CLI_BUILD_NAME=docker-local-build
            - export JFROG_CLI_BUILD_NUMBER=${run_id}
            - ./docker-build.sh
            - ./docker-push.sh
            - cat ./DOC_OUT_PATH.txt
            - save_artifact_info 'file' $(cat ./DOC_OUT_PATH.txt)
            - cat ./DOC_BP_OUT_PATH.txt
            - save_artifact_info buildInfo $(cat ./DOC_BP_OUT_PATH) --build-name $(cat ./OUTPUT_BUILD_NAME.txt) --build-number $(./OUTPUT_BUILD_NUMBER.txt)

  - name: signed_pipelines_docker_using_task
    configuration:
      jfrogCliVersion: 2
    steps:
      - name: build_push
        type: Bash
        configuration:
          inputResources:
            - name: git_repo
          integrations:
            - name: int_default_artifactory
          outputResources:
            - name: buildInfo
        execution:
          onExecute:
            - echo $res_git_repo_resourcePath
            - task: jfrog/docker-build@v0.0.1
              repository: pipelines-tasks-virtual
              input:
                resourceName: git_repo
                # dockerImage: "b14810.jfrog-pipelines.com/docker-local/jfrog/pipelines-msg:latest"
                # dockerImage: "pipelineslnp1.jfrogdev.org/docker-local/jfrog/pipelines-msg:latest"
                dockerImage: "jpd957291677.jfrogdev.org/docker-local/jfrog/pipelines-msg:latest"
                dockerFileName: Dockerfile
                dockerFileLocation: .
            - task: jfrog/docker-push@v0.0.1
              repository: pipelines-tasks-virtual
              input:
                # dockerImage: "b14810.jfrog-pipelines.com/docker-local/jfrog/pipelines-msg:latest"
                # dockerImage: "pipelineslnp1.jfrogdev.org/docker-local/jfrog/pipelines-msg:latest"
                dockerImage: "jpd957291677.jfrogdev.org/docker-local/jfrog/pipelines-msg:latest"
                autoPublishBuildInfo: "true"
                xrayScan: "false"
                failOnScan: "true"
                outputBuildInfoResourceName: "buildInfo"
            
  - name: signed_pipelines_manual
    configuration:
      jfrogCliVersion: 2
    steps:
      - name: create_with_buildinfo
        type: Bash
        configuration:
          inputResources:
            - name: git_repo
          integrations:
            - name: int_default_artifactory
          outputResources:
            - name: buildInfo
        execution:
          onExecute:
            - cd $res_git_repo_resourcePath
            - 'echo ''12345'' > server_${run_id}.js'
            - >-
              jfrog rt upload server_${run_id}.js km-generic-local --build-name
              $JFROG_CLI_BUILD_NAME --build-number $JFROG_CLI_BUILD_NUMBER
            - 'echo ''6789'' > dependency_${run_id}.js'
            - >-
              jfrog rt upload dependency_${run_id}.js km-generic-local
              --build-name $JFROG_CLI_BUILD_NAME --build-number
              $JFROG_CLI_BUILD_NUMBER
            - >-
              jf rt bad $JFROG_CLI_BUILD_NAME $JFROG_CLI_BUILD_NUMBER
              "km-generic-local/dependency_${run_id}.js" --from-rt
            - jf rt bce $JFROG_CLI_BUILD_NAME $JFROG_CLI_BUILD_NUMBER
            - >-
              jfrog rt build-publish --detailed-summary $JFROG_CLI_BUILD_NAME
              $JFROG_CLI_BUILD_NUMBER > summaryOutput.json
            - >-
              save_artifact_info 'buildInfo' './summaryOutput.json' --build-name
              $JFROG_CLI_BUILD_NAME --build-number $JFROG_CLI_BUILD_NUMBER
            - write_output buildInfo "buildName=$JFROG_CLI_BUILD_NAME"
            - write_output buildInfo "buildNumber=$JFROG_CLI_BUILD_NUMBER"
      # - name: create_with_buildinfo_matrix
      #   type: Matrix
      #   stepletMultipliers:
      #     environmentVariables:
      #       - id: 1
      #       - id: 2
      #   configuration:
      #     inputSteps:
      #       - name: create_with_buildinfo
      #     inputResources:
      #       - name: git_repo
      #     integrations:
      #       - name: int_default_artifactory
      #     outputResources:
      #       - name: buildInfo
      #   execution:
      #     onExecute:
      #       - cd $res_git_repo_resourcePath
      #       - 'touch server_${steplet_id}.js'
      #       - 'jfrog rt upload server_${steplet_id}.js km-generic-local'
      #       - >-
      #         jfrog rt build-publish --detailed-summary $JFROG_CLI_BUILD_NAME
      #         $JFROG_CLI_BUILD_NUMBER > summaryOutput.json
      #       - >-
      #         save_artifact_info 'buildInfo' './summaryOutput.json' --build-name
      #         $JFROG_CLI_BUILD_NAME --build-number $JFROG_CLI_BUILD_NUMBER
      #       - write_output buildInfo "buildName=$JFROG_CLI_BUILD_NAME"
      #       - write_output buildInfo "buildNumber=$JFROG_CLI_BUILD_NUMBER"
      - name: create_only_artifact
        type: Bash
        configuration:
          inputSteps:
            - name: create_with_buildinfo
          inputResources:
            - name: git_repo
          integrations:
            - name: int_default_artifactory
        execution:
          onExecute:
            - cd $res_git_repo_resourcePath
            - touch server1.js
            - >-
              jfrog rt upload server1.js km-generic-local --detailed-summary >
              summaryOutput.json
            - save_artifact_info 'file' './summaryOutput.json'
      - name: create_with_release_bundle
        type: Bash
        configuration:
          inputSteps:
            - name: create_only_artifact
          inputResources:
            - name: git_repo
          integrations:
            - name: int_default_artifactory
        execution:
          onExecute:
            - cd $res_git_repo_resourcePath
            - >
              echo '{ "files": [ { "aql": { "items.find": { "repo": { "$eq":
              "km-generic-local" } } } } ] }' > spec.json
            - jf rt s --spec=spec.json
            - >-
              jf ds rbc --spec=spec.json kunal_test_rb_${run_id} 1.0.0 --sign
              --detailed-summary > summaryOutput.json
            - >-
              save_artifact_info 'releaseBundle' './summaryOutput.json'
              --release-bundle-name kunal_test_rb_${run_id}
              --release-bundle-version 1.0.0
      - name: validate_artifact
        type: Bash
        configuration:
          inputSteps:
            - name: create_with_release_bundle
        execution:
          onExecute:
            - >-
              validate_artifact buildInfo --build-name $JFROG_CLI_BUILD_NAME
              --build-number $JFROG_CLI_BUILD_NUMBER
